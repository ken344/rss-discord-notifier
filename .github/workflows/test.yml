name: Go Tests

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®Pushæ™‚
  push:
    branches:
      - main
  
  # Pull Requestæ™‚ï¼ˆä»»æ„ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ï¼‰
  pull_request:
    branches:
      - main
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      log_level:
        description: 'ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARN
          - ERROR

# ç’°å¢ƒå¤‰æ•°
env:
  GO_VERSION: '1.21'

jobs:
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10åˆ†ï¼‰
    timeout-minutes: 10
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
      
      # 2. Goç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Goç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # 3. ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Goä¾å­˜é–¢ä¿‚ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: go mod download
      
      # 4. go mod tidyã§ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
      - name: ä¾å­˜é–¢ä¿‚ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum
      
      # 5. gofmtã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
      - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:"
            gofmt -s -l .
            exit 1
          fi
      
      # 6. go vetã§é™çš„è§£æ
      - name: é™çš„è§£æã‚’å®Ÿè¡Œ (go vet)
        run: go vet ./...
      
      # 7. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰
      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      
      # 8. ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤º
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤º
        run: go tool cover -func=coverage.out
      
      # 9. ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-report
          path: coverage.out
          retention-days: 30
      
      # 10. ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã§ãã‚‹ã‹ç¢ºèªï¼‰
      - name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        run: go build -v -o bin/notifier cmd/notifier/main.go
      
      # 11. å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
      - name: å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        run: |
          if [ ! -f bin/notifier ]; then
            echo "å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          echo "âœ“ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
          ls -lh bin/notifier
      
      # 12. ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
      - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: ${{ env.GO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: Ubuntu Latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
            echo "- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: $COVERAGE" >> $GITHUB_STEP_SUMMARY
          fi

  # Linterã‚¸ãƒ§ãƒ–ï¼ˆgolangci-lintã‚’ä½¿ç”¨ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  lint:
    name: Lintå®Ÿè¡Œ
    runs-on: ubuntu-latest
    
    timeout-minutes: 10
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
      
      - name: Goç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # golangci-lintã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ãªLintï¼‰
      - name: golangci-lintã‚’å®Ÿè¡Œ
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          # .golangci.ymlã®è¨­å®šã‚’ä½¿ç”¨
          args: --config=.golangci.yml

