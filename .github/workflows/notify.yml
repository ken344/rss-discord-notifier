name: RSS to Discord Notification

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # Cronã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šæœŸå®Ÿè¡Œ
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆUTCæ™‚åˆ»ï¼‰
    # ä¾‹: æ—¥æœ¬æ™‚é–“ã§æ¯æ™‚9åˆ†é ƒï¼ˆUTCã¯ç´„9åˆ†é…å»¶ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰
    - cron: '0 * * * *'
    
    # ä»–ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ä½¿ç”¨ï¼‰:
    # - cron: '*/30 * * * *'      # 30åˆ†ã”ã¨
    # - cron: '0 */2 * * *'       # 2æ™‚é–“ã”ã¨
    # - cron: '0 9,12,15,18 * * *' # 9æ™‚ã€12æ™‚ã€15æ™‚ã€18æ™‚ï¼ˆUTCï¼‰
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      log_level:
        description: 'ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARN
          - ERROR

# ç’°å¢ƒå¤‰æ•°ï¼ˆã‚¸ãƒ§ãƒ–å…¨ä½“ã§ä½¿ç”¨ï¼‰
env:
  GO_VERSION: '1.21'
  STATE_DIR: 'state'

jobs:
  notify:
    name: RSSè¨˜äº‹ã‚’Discordã«é€šçŸ¥
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10åˆ†ï¼‰
    timeout-minutes: 10
    
    # ã‚¸ãƒ§ãƒ–ãƒ¬ãƒ™ãƒ«ã®ç’°å¢ƒå¤‰æ•°
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_WEBHOOK_URL_TECH: ${{ secrets.DISCORD_WEBHOOK_URL_TECH }}
      DISCORD_WEBHOOK_URL_NEWS: ${{ secrets.DISCORD_WEBHOOK_URL_NEWS }}
      DISCORD_WEBHOOK_URL_BLOG: ${{ secrets.DISCORD_WEBHOOK_URL_BLOG }}
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      # 2. Goç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Goç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # 3. ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Goä¾å­˜é–¢ä¿‚ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: go mod download
      
      # 4. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
      - name: çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ
        id: cache-state
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.STATE_DIR }}/
          key: rss-state-${{ github.run_number }}
          restore-keys: |
            rss-state-
      
      # 5. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Artifactsã‹ã‚‰å¾©å…ƒï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
      - name: çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Artifactsã‹ã‚‰å¾©å…ƒï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ï¼‰
        if: steps.cache-state.outputs.cache-hit != 'true'
        uses: dawidd6/action-download-artifact@v2
        continue-on-error: true
        with:
          name: rss-state
          path: ${{ env.STATE_DIR }}/
          workflow_conclusion: success
          if_no_artifact_found: ignore
      
      # 6. çŠ¶æ…‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
      - name: çŠ¶æ…‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: mkdir -p ${{ env.STATE_DIR }}
      
      # 7. RSS Discord Notifierã‚’å®Ÿè¡Œ
      - name: RSS Discord Notifierã‚’å®Ÿè¡Œ
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL_TECH: ${{ secrets.DISCORD_WEBHOOK_URL_TECH }}
          DISCORD_WEBHOOK_URL_NEWS: ${{ secrets.DISCORD_WEBHOOK_URL_NEWS }}
          DISCORD_WEBHOOK_URL_BLOG: ${{ secrets.DISCORD_WEBHOOK_URL_BLOG }}
          LOG_LEVEL: ${{ inputs.log_level || 'INFO' }}
          LOG_FORMAT: 'json'
          CONFIG_FILE_PATH: './configs/feeds.yaml'
          STATE_FILE_PATH: './state/state.json'
        run: |
          echo "ğŸš€ RSS Discord Notifierã‚’èµ·å‹•..."
          echo "ğŸ“‹ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯:"
          echo "  CONFIG_FILE_PATH: $CONFIG_FILE_PATH"
          echo "  STATE_FILE_PATH: $STATE_FILE_PATH"
          echo "  LOG_LEVEL: $LOG_LEVEL"
          echo "  LOG_FORMAT: $LOG_FORMAT"
          
          echo "ğŸ“ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          if [ -f "$CONFIG_FILE_PATH" ]; then
            echo "  âœ… $CONFIG_FILE_PATH ãŒå­˜åœ¨ã—ã¾ã™"
            echo "  ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < "$CONFIG_FILE_PATH") bytes"
          else
            echo "  âŒ $CONFIG_FILE_PATH ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi
          
          echo "ğŸ”„ ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Ÿè¡Œ..."
          go run cmd/notifier/main.go 2>&1 || {
            EXIT_CODE=$?
            echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (exit code: $EXIT_CODE)"
            exit $EXIT_CODE
          }
          echo "âœ… å®Ÿè¡Œå®Œäº†"
      
      # 9. å®Ÿè¡Œçµæœã®ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
      - name: å®Ÿè¡Œçµæœã‚’ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        if: always()
        run: |
          echo "## ğŸ“Š å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "state/state.json" ]; then
            echo "- **çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«**: å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat state/state.json | head -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«**: æœªä½œæˆï¼ˆåˆå›å®Ÿè¡Œã®å¯èƒ½æ€§ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
      
      # 9. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
      - name: çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.STATE_DIR }}/
          key: rss-state-${{ github.run_number }}
      
      # 10. çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Artifactsã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
      - name: çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Artifactsã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rss-state
          path: ${{ env.STATE_DIR }}/
          retention-days: 30
          if-no-files-found: ignore
      
      # 11. ã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ã‚¨ãƒ©ãƒ¼é€šçŸ¥
        if: failure() && env.DISCORD_WEBHOOK_URL != ''
        continue-on-error: true
        run: |
          curl -X POST "${{ env.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âš ï¸ RSS Discord Notifier ã‚¨ãƒ©ãƒ¼",
                "description": "Workflowã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Repository",
                    "value": "${{ github.repository }}",
                    "inline": true
                  },
                  {
                    "name": "Workflow",
                    "value": "${{ github.workflow }}",
                    "inline": true
                  },
                  {
                    "name": "Run ID",
                    "value": "[${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                    "inline": true
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'

